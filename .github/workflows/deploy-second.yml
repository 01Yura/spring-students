name: Deploy to Kubernetes Cluster

# Workflow для деплоя приложения в Kubernetes кластер
# Требуемые секреты в настройках репозитория (Settings -> Secrets and variables -> Actions):
#   DEPLOY_SECOND_HOST - IP адрес мастер ноды
#   DEPLOY_SECOND_USER - пользователь для SSH
#   DEPLOY_SECOND_PASSWORD - пароль для SSH

on:
  push:
    branches:
      - main
    paths:
      - "k8s/**"
      - ".github/workflows/deploy-second.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy Kubernetes manifests to master node
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_SECOND_HOST }}
          username: ${{ secrets.DEPLOY_SECOND_USER }}
          password: ${{ secrets.DEPLOY_SECOND_PASSWORD }}
          port: 22
          source: "k8s/app-deployment.yaml,k8s/app-service.yaml,k8s/metallb-config.yaml,k8s/ingress-nginx-deployment.yaml,k8s/ingress.yaml"
          target: "/tmp/spring-students-k8s"

      - name: Deploy to Kubernetes cluster
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SECOND_HOST }}
          username: ${{ secrets.DEPLOY_SECOND_USER }}
          password: ${{ secrets.DEPLOY_SECOND_PASSWORD }}
          port: 22
          script: |
            set -e

            cd /tmp/spring-students-k8s

            # Проверяем, что все файлы скопированы
            echo "Checking if all required files are present..."
            echo "Files in current directory:"
            ls -la
            echo ""
            echo "Files in k8s subdirectory (if exists):"
            ls -la k8s/ 2>/dev/null || echo "No k8s subdirectory"
            echo ""

            # Перемещаем файлы из подпапки, если они там оказались
            if [ -d "k8s" ]; then
              echo "Moving files from k8s subdirectory..."
              mv k8s/*.yaml . 2>/dev/null || true
              rmdir k8s 2>/dev/null || true
              echo "Files after moving:"
              ls -la *.yaml
            fi
            echo ""

            # Проверяем наличие всех необходимых файлов
            echo "Checking required files:"
            MISSING_FILES=0
            for file in app-deployment.yaml app-service.yaml metallb-config.yaml ingress-nginx-deployment.yaml ingress.yaml; do
              if [ -f "$file" ]; then
                echo "  ✓ $file found"
              else
                echo "  ✗ $file NOT FOUND!"
                MISSING_FILES=1
              fi
            done
            echo ""

            if [ $MISSING_FILES -eq 1 ]; then
              echo "ERROR: Some required files are missing!"
              echo "This might be a problem with file copying in the pipeline."
              exit 1
            fi

            # Перемещаем файлы из подпапки, если они там оказались
            [ -d "k8s" ] && mv k8s/*.yaml . 2>/dev/null && rmdir k8s 2>/dev/null || true

            echo "=========================================="
            echo "Step 1: Installing/Checking MetalLB"
            echo "=========================================="

            # Проверяем, установлен ли MetalLB
            if ! kubectl get namespace metallb-system &>/dev/null; then
              echo "MetalLB not found, installing..."
              kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml

              # Ждем готовности MetalLB
              echo "Waiting for MetalLB to be ready..."
              kubectl wait --namespace metallb-system \
                --for=condition=ready pod \
                --selector=app=metallb \
                --timeout=180s || true
            else
              echo "MetalLB is already installed"
            fi

            echo ""
            echo "=========================================="
            echo "Step 2: Applying MetalLB configuration"
            echo "=========================================="
            kubectl apply -f metallb-config.yaml

            echo ""
            echo "=========================================="
            echo "Step 3: Deploying ingress-nginx"
            echo "=========================================="
            kubectl apply -f ingress-nginx-deployment.yaml

            # Проверяем, что права на endpointslices применены
            echo "Checking if endpointslices permissions are applied..."
            if kubectl describe clusterrole ingress-nginx | grep -q "endpointslices"; then
              echo "✓ endpointslices permissions found in ClusterRole"
            else
              echo "⚠ Warning: endpointslices permissions not found, but continuing..."
            fi

            # Перезапускаем поды ingress-nginx, чтобы они получили обновленные права
            # Это важно, так как поды кэшируют токены и права при старте
            echo "Restarting ingress-nginx pods to apply updated RBAC permissions..."
            kubectl rollout restart deployment/ingress-nginx-controller -n ingress-nginx || true

            # Ждем готовности ingress-nginx подов после перезапуска
            echo "Waiting for ingress-nginx pods to be ready after restart..."
            kubectl wait --namespace ingress-nginx \
              --for=condition=ready pod \
              --selector=app.kubernetes.io/name=ingress-nginx \
              --timeout=180s || true

            # Проверяем логи на наличие ошибок RBAC (должны исчезнуть после перезапуска)
            echo "Checking ingress-nginx logs for RBAC errors..."
            sleep 5  # Даем время подам полностью запуститься
            # Временно отключаем строгий режим для проверки логов
            set +e
            LOG_CHECK=$(kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --tail=10 2>&1 | grep -c "endpointslices.*forbidden" || echo "0")
            set -e
            if [ "$LOG_CHECK" -gt 0 ]; then
              echo "⚠ Warning: Still seeing endpointslices RBAC errors in logs"
              echo "This might resolve after a few minutes as pods refresh their tokens"
            else
              echo "✓ No endpointslices RBAC errors found in recent logs"
            fi

            # Ждем назначения LoadBalancer IP
            echo "Waiting for LoadBalancer IP assignment..."
            INGRESS_IP=""
            for i in {1..30}; do
              INGRESS_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
              if [ -n "$INGRESS_IP" ]; then
                break
              fi
              echo "Attempt $i/30: Waiting for IP assignment..."
              sleep 5
            done

            if [ -z "$INGRESS_IP" ]; then
              echo "Warning: LoadBalancer IP not assigned yet. It may take a few minutes."
              echo "Check with: kubectl get svc -n ingress-nginx"
            else
              echo "ingress-nginx LoadBalancer IP: $INGRESS_IP"
            fi

            echo ""
            echo "=========================================="
            echo "Step 4: Updating application service (ClusterIP)"
            echo "=========================================="
            kubectl apply -f app-service.yaml

            echo ""
            echo "=========================================="
            echo "Step 5: Updating application deployment"
            echo "=========================================="

            # Проверяем наличие файла
            if [ ! -f "app-deployment.yaml" ]; then
              echo "ERROR: app-deployment.yaml not found!"
              ls -la *.yaml
              exit 1
            fi
            echo "✓ app-deployment.yaml found"

            # Удаляем старые поды для пересоздания с новым образом
            # imagePullPolicy: Always в deployment гарантирует загрузку нового образа
            kubectl delete pods -l app=spring-students-app --ignore-not-found=true || true

            echo "Applying app-deployment.yaml..."
            # Временно отключаем строгий режим для проверки результата
            set +e
            APPLY_OUTPUT=$(kubectl apply -f app-deployment.yaml 2>&1)
            APPLY_EXIT_CODE=$?
            set -e

            echo "kubectl apply exit code: $APPLY_EXIT_CODE"
            echo "kubectl apply output:"
            echo "$APPLY_OUTPUT"

            if [ $APPLY_EXIT_CODE -ne 0 ]; then
              echo "ERROR: Failed to apply app-deployment.yaml!"
              echo "Trying to validate YAML..."
              kubectl apply -f app-deployment.yaml --dry-run=client
              exit 1
            fi

            # Проверяем, что Deployment создан
            sleep 2  # Даем время Kubernetes обработать запрос
            if ! kubectl get deployment -n default spring-students-app &>/dev/null; then
              echo "ERROR: Deployment was not created after apply!"
              echo "Checking if it exists in other namespace..."
              kubectl get deployment --all-namespaces | grep spring-students-app || echo "Deployment not found in any namespace"
              echo "Trying to see what went wrong with dry-run..."
              kubectl apply -f app-deployment.yaml --dry-run=client -o yaml | head -50
              exit 1
            fi
            echo "✓ Deployment created successfully"

            # Ждем готовности deployment (все реплики запущены и готовы)
            echo "Waiting for application pods to be ready..."
            kubectl wait --for=condition=available --timeout=300s deployment/spring-students-app || true

            echo ""
            echo "=========================================="
            echo "Step 6: Applying Ingress resource"
            echo "=========================================="
            kubectl apply -f ingress.yaml

            echo ""
            echo "=========================================="
            echo "Deployment Summary"
            echo "=========================================="
            echo ""
            echo "Application pods:"
            kubectl get pods -l app=spring-students-app
            echo ""
            echo "ingress-nginx pods:"
            kubectl get pods -n ingress-nginx
            echo ""
            echo "Services:"
            kubectl get svc -n ingress-nginx ingress-nginx-controller
            echo ""
            echo "Ingress:"
            kubectl get ingress
            echo ""

            if [ -n "$INGRESS_IP" ]; then
              echo "=========================================="
              echo "Application is accessible at:"
              echo "  - http://$INGRESS_IP/"
              echo "  - http://spring-students.local/ (if /etc/hosts configured)"
              echo "=========================================="
            else
              echo "=========================================="
              echo "To get the LoadBalancer IP, run:"
              echo "  kubectl get svc -n ingress-nginx ingress-nginx-controller"
              echo "=========================================="
            fi
